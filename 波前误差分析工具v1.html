<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>波前误差分析工具 - 布局优化版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary-bg: #0a0e17;
            --secondary-bg: #121a2b;
            --accent-blue: #1a73e8;
            --accent-purple: #8a2be2;
            --accent-cyan: #00bcd4;
            --accent-green: #4caf50;
            --accent-orange: #ff9800;
            --accent-red: #f44336;
            --text-light: #e0e0e0;
            --text-lighter: #ffffff;
            --border-color: #2a3a5c;
            --card-bg: rgba(26, 35, 58, 0.7);
            --atmosphere-color: rgba(0, 188, 212, 0.1);
            --telescope-color: rgba(138, 43, 226, 0.1);
            --ao-color: rgba(76, 175, 80, 0.1);
            --sensor-color: rgba(255, 152, 0, 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-bg) 0%, #152642 100%);
            color: var(--text-light);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            background-attachment: fixed;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }
        
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            grid-column: 1 / -1;
        }
        
        h1, h2, h3 {
            color: var(--text-lighter);
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        h1 {
            font-size: 2.2rem;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .section:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }
        
        .param-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .param-item {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--accent-cyan);
            font-size: 0.95rem;
        }
        
        input, select {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            background: rgba(10, 20, 40, 0.7);
            color: var(--text-light);
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        button {
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
        }
        
        button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }
        
        button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-card {
            background: rgba(15, 25, 50, 0.8);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-cyan);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .result-value {
            font-size: 28px;
            font-weight: 700;
            margin: 10px 0;
            color: var(--text-lighter);
        }
        
        .result-desc {
            color: #a0a0a0;
            font-size: 14px;
        }
        
        .intermediate-vars {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .var-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }
        
        .var-name {
            color: #b0b0b0;
        }
        
        .var-value {
            font-weight: 600;
            color: var(--text-lighter);
        }
        
        .chart-container {
            height: 400px;
            margin-top: 20px;
            background: rgba(15, 25, 50, 0.5);
            border-radius: 8px;
            padding: 15px;
        }
        
        .error-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .error-item {
            background: rgba(15, 25, 50, 0.8);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .error-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--accent-cyan);
        }
        
        .error-percentage {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-lighter);
        }
        
        .mermaid {
            background: rgba(15, 25, 50, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .file-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .file-input {
            display: none;
        }
        
        .param-category {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .atmosphere {
            background-color: var(--atmosphere-color);
            border-left: 4px solid var(--accent-cyan);
        }
        
        .telescope {
            background-color: var(--telescope-color);
            border-left: 4px solid var(--accent-purple);
        }
        
        .ao {
            background-color: var(--ao-color);
            border-left: 4px solid var(--accent-green);
        }
        
        .sensor {
            background-color: var(--sensor-color);
            border-left: 4px solid var(--accent-orange);
        }
        
        .expandable {
            margin-top: 15px;
        }
        
        .expand-btn {
            background: transparent;
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            padding: 8px 15px;
            font-size: 14px;
            margin: 0;
            width: 100%;
        }
        
        .expand-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 0 15px;
        }
        
        .expand-content.expanded {
            max-height: 500px;
            padding: 15px;
        }
        
        .formula-section {
            background: rgba(15, 25, 50, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .formula {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 3px solid var(--accent-cyan);
        }
        
        .chart-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .chart-control-item {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .left-panel, .right-panel {
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .param-group, .results-grid, .error-breakdown {
                grid-template-columns: 1fr;
            }
            
            .chart-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>波前误差分析工具 - 布局优化版</h1>
            <p>天文自适应光学系统波前残差计算与可视化分析</p>
        </header>
        
        <div class="left-panel">
            <section class="section">
                <h2>系统参数配置</h2>
                
                <div class="file-controls">
                    <button id="saveParamsBtn">保存参数</button>
                    <button id="loadParamsBtn" class="secondary">载入参数</button>
                    <input type="file" id="fileInput" class="file-input" accept=".json">
                    <button id="resetBtn" class="secondary">重置参数</button>
                </div>
                
                <div class="param-category atmosphere">
                    <h3>大气环境参数</h3>
                    <div class="param-group">
                        <div class="param-item">
                            <label>r0参考值 (cm) @550nm</label>
                            <input type="number" id="r0_ref" value="10" step="0.1" min="1" max="30">
                        </div>
                        <div class="param-item">
                            <label>导星波长 (nm)</label>
                            <input type="number" id="wavelength_guide" value="589" step="1" min="400" max="1000">
                        </div>
                        <div class="param-item">
                            <label>天顶大气透过率</label>
                            <input type="number" id="tau_a" value="0.9" step="0.05" min="0.1" max="1.0">
                        </div>
                        <div class="param-item">
                            <label>Greenwood频率 f_G (Hz)</label>
                            <input type="number" id="f_G" value="50" step="5" min="10" max="500">
                        </div>
                    </div>
                </div>
                
                <div class="param-category telescope">
                    <h3>望远镜系统参数</h3>
                    <div class="param-group">
                        <div class="param-item">
                            <label>望远镜口径 (m)</label>
                            <input type="number" id="D" value="2.0" step="0.1" min="0.5" max="10">
                        </div>
                        <div class="param-item">
                            <label>遮拦比</label>
                            <input type="number" id="epsilon" value="0.18" step="0.01" min="0" max="0.5">
                        </div>
                        <div class="param-item">
                            <label>仰角 (度)</label>
                            <input type="number" id="elevation" value="60" step="1" min="0" max="90">
                        </div>
                        <div class="param-item">
                            <label>光学系统效率</label>
                            <input type="number" id="tau_o" value="0.8" step="0.05" min="0.1" max="1.0">
                        </div>
                    </div>
                </div>
                
                <div class="param-category ao">
                    <h3>自适应光学参数</h3>
                    <div class="param-group">
                        <div class="param-item">
                            <label>DM单元数 N</label>
                            <input type="number" id="N" value="400" step="10" min="50" max="1000">
                        </div>
                        <div class="param-item">
                            <label>帧频 f_frame (Hz)</label>
                            <input type="number" id="f_frame" value="1000" step="10" min="100" max="5000">
                        </div>
                        <div class="param-item">
                            <label>系统带宽比</label>
                            <input type="number" id="f_e3db_ratio" value="25" step="1" min="20" max="35">
                        </div>
                        <div class="param-item">
                            <label>拟合误差系数</label>
                            <input type="number" id="k_fitting" value="0.3" step="0.05" min="0.1" max="1.0">
                        </div>
                        <div class="param-item">
                            <label>杂项误差 (rad²)</label>
                            <input type="number" id="sigma_miscel" value="0.05" step="0.01" min="0" max="0.5">
                        </div>
                    </div>
                </div>
                
                <div class="param-category sensor">
                    <h3>波前传感器参数</h3>
                    <div class="param-group">
                        <div class="param-item">
                            <label>导星星等</label>
                            <input type="number" id="magnitude" value="8.0" step="0.1" min="0" max="20">
                        </div>
                        <div class="param-item">
                            <label>量子效率</label>
                            <input type="number" id="eta" value="0.9" step="0.05" min="0.1" max="1.0">
                        </div>
                        <div class="param-item">
                            <label>读出噪声 (e-)</label>
                            <input type="number" id="sigma_R" value="0.3" step="0.1" min="0" max="5">
                        </div>
                        <div class="param-item">
                            <label>暗电流 (e-/pixel/s)</label>
                            <input type="number" id="I_D" value="0.01" step="0.01" min="0" max="1">
                        </div>
                        <div class="param-item">
                            <label>子光斑像素数</label>
                            <input type="number" id="K" value="9" step="1" min="4" max="64">
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="calculateBtn">计算波前误差</button>
                </div>
            </section>
        </div>
        
        <div class="right-panel">
            <section class="section">
                <h2>参数关系流程图</h2>
                <div class="mermaid">
flowchart TD
    A[大气环境参数] --> E[波前误差计算]
    A1[r0参考值 r₀<br>@550nm] --> A
    A2[导星波长 λ<sub>guide</sub>] --> A
    A3[大气透过率 τ<sub>a</sub>] --> A
    A4[Greenwood频率 f<sub>G</sub>] --> A
    
    B[望远镜系统参数] --> E
    B1[望远镜口径 D] --> B
    B2[遮拦比 ε] --> B
    B3[仰角 θ] --> B
    B4[光学系统效率 τ<sub>o</sub>] --> B
    
    C[自适应光学参数] --> E
    C1[DM单元数 N] --> C
    C2[帧频 f<sub>frame</sub>] --> C
    C3[系统带宽比 f<sub>e3db</sub>] --> C
    C4[拟合误差系数 k<sub>fitting</sub>] --> C
    C5[杂项误差 σ<sub>miscel</sub>] --> C
    
    D[波前传感器参数] --> E
    D1[导星星等 m<sub>v</sub>] --> D
    D2[量子效率 η] --> D
    D3[读出噪声 σ<sub>R</sub>] --> D
    D4[暗电流 I<sub>D</sub>] --> D
    D5[子光斑像素数 K] --> D
    
    E --> F[总波前误差 σ<sup>2</sup><sub>total</sub>]
    E1[拟合误差 σ<sup>2</sup><sub>fitting</sub>] --> E
    E2[时间误差 σ<sup>2</sup><sub>temporal</sub>] --> E
    E3[噪声误差 σ<sup>2</sup><sub>noise</sub>] --> E
    E4[杂项误差 σ<sup>2</sup><sub>miscel</sub>] --> E
    
    F --> G[斯特列尔比 SR]
    G --> H[等效纳米误差 @1550nm]
    H --> I[单模耦合效率 η<sub>SMF</sub>]
    
    J[模式匹配效率] --> I
    K[精跟踪脱靶量] --> I
                </div>
            </section>
            
            <section class="section">
                <h2>计算结果</h2>
                
                <div class="results-grid">
                    <div class="result-card">
                        <h3>总波前误差</h3>
                        <div class="result-value" id="total_error">-</div>
                        <div class="result-desc">均方根误差 (rad)</div>
                    </div>
                    
                    <div class="result-card">
                        <h3>等效纳米误差</h3>
                        <div class="result-value" id="nm_error">-</div>
                        <div class="result-desc">@1550nm波长 (nm)</div>
                    </div>
                    
                    <div class="result-card">
                        <h3>斯特列尔比</h3>
                        <div class="result-value" id="sr_value">-</div>
                        <div class="result-desc">成像质量指标</div>
                    </div>
                    
                    <div class="result-card">
                        <h3>目标评估</h3>
                        <div class="result-value" id="target_eval">-</div>
                        <div class="result-desc">λ/4@1550nm (387.5nm)</div>
                    </div>
                </div>
                
                <h3>误差分量分析</h3>
                <div class="error-breakdown">
                    <div class="error-item">
                        <div class="error-title">拟合误差</div>
                        <div class="error-percentage" id="fitting_percent">-</div>
                        <div class="result-desc">方差: <span id="fitting_variance">-</span> rad²</div>
                    </div>
                    
                    <div class="error-item">
                        <div class="error-title">时间误差</div>
                        <div class="error-percentage" id="temporal_percent">-</div>
                        <div class="result-desc">方差: <span id="temporal_variance">-</span> rad²</div>
                    </div>
                    
                    <div class="error-item">
                        <div class="error-title">噪声误差</div>
                        <div class="error-percentage" id="noise_percent">-</div>
                        <div class="result-desc">方差: <span id="noise_variance">-</span> rad²</div>
                    </div>
                    
                    <div class="error-item">
                        <div class="error-title">杂项误差</div>
                        <div class="error-percentage" id="misc_percent">-</div>
                        <div class="result-desc">方差: <span id="misc_variance">-</span> rad²</div>
                    </div>
                </div>
                
                <h3>中间计算结果</h3>
                <div class="intermediate-vars" id="intermediate_vars">
                    <!-- 中间变量将通过JS动态生成 -->
                </div>
                
                <div class="expandable">
                    <button class="expand-btn" id="toggleFormulasBtn">显示计算公式</button>
                    <div class="expand-content" id="formulasContent">
                        <div class="formula-section">
                            <h4>光子流量密度</h4>
                            <div class="formula">φ_s = 4×10^6 × 10^(-m_v/2.5) photons/cm²-s</div>
                            
                            <h4>子孔径参数</h4>
                            <div class="formula">D_sub = D / √N</div>
                            <div class="formula">A_sub = π × (D_sub/2)²</div>
                            <div class="formula">A_effective = A_sub × (1 - ε²)</div>
                            
                            <h4>信号电子数</h4>
                            <div class="formula">S_M = (φ_s × η × t_int × A_effective × τ_a × τ_o) / K</div>
                            
                            <h4>信噪比</h4>
                            <div class="formula">SNR = S_M / √(S_M + σ_R² + t_int × I_D)</div>
                            
                            <h4>导星波长r0</h4>
                            <div class="formula">r0_guide = r0_ref × (λ_guide/λ_ref)^1.2</div>
                            
                            <h4>误差分量</h4>
                            <div class="formula">σ²_fitting = k × (D/r0_guide)^(5/3) × N^(-5/6)</div>
                            <div class="formula">σ²_temporal = (f_G / f_e3db)^(5/3)</div>
                            <div class="formula">σ²_noise = 1 / SNR²</div>
                            <div class="formula">σ²_total = σ²_fitting + σ²_temporal + σ²_noise + σ²_miscel</div>
                            
                            <h4>斯特列尔比</h4>
                            <div class="formula">SR = exp(-σ²_total)</div>
                            
                            <h4>等效纳米误差</h4>
                            <div class="formula">σ_nm = σ_total × λ / (2π) × 10^9</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="section">
                <h2>参数变化分析</h2>
                <div class="chart-controls">
                    <div class="chart-control-item">
                        <label>分析参数</label>
                        <select id="paramSelect">
                            <option value="r0_ref">r0 (大气相干长度)</option>
                            <option value="N">DM单元数</option>
                            <option value="f_frame">帧频</option>
                            <option value="f_G">Greenwood频率</option>
                            <option value="magnitude">导星星等</option>
                            <option value="elevation">仰角</option>
                        </select>
                    </div>
                    <div class="chart-control-item">
                        <label>最小值</label>
                        <input type="number" id="paramMin" value="5" step="1">
                    </div>
                    <div class="chart-control-item">
                        <label>最大值</label>
                        <input type="number" id="paramMax" value="20" step="1">
                    </div>
                    <div class="chart-control-item">
                        <label>点数</label>
                        <input type="number" id="paramPoints" value="10" step="1" min="5" max="20">
                    </div>
                    <div class="chart-control-item" style="justify-content: flex-end;">
                        <button id="updateChartBtn">更新分析图表</button>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="errorChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="nmChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="srChart"></canvas>
                </div>
            </section>
        </div>
    </div>

    <script>
        // 波前误差分析类
        class WavefrontErrorAnalysis {
            constructor() {
                this.wavelength_r0_ref = 550e-9; // r0参考波长(m)
            }
            
            // 计算天顶距（弧度）
            calculateZenithAngle(elevation_deg) {
                const elevation_rad = elevation_deg * Math.PI / 180;
                return Math.PI/2 - elevation_rad; // 天顶距 = 90° - 仰角
            }
            
            // 计算仰角调整后的大气相干长度
            calculateR0AtElevation(r0_ref, elevation_deg) {
                const z = this.calculateZenithAngle(elevation_deg);
                // r0(z) = r0_zenith * (cos z)^(3/5)
                return r0_ref * Math.pow(Math.cos(z), 3/5);
            }
            
            // 计算仰角调整后的大气透过率
            calculateTauAAtElevation(tau_a_zenith, elevation_deg) {
                const z = this.calculateZenithAngle(elevation_deg);
                const sec_z = 1 / Math.cos(z);
                // τ(z) = τ_zenith^(sec z)
                return Math.pow(tau_a_zenith, sec_z);
            }
            
            // 计算导星波长处的大气相干长度
            calculateR0AtWavelength(r0_ref, wavelength_target) {
                // r0 ∝ λ^(6/5) = λ^1.2
                return r0_ref * Math.pow(wavelength_target / this.wavelength_r0_ref, 1.2);
            }
            
            // 计算恒星光子流量密度
            calculatePhotonFlux(magnitude) {
                // φ_s = 4×10^6 × 10^(-m_v/2.5) photons/cm²-s
                const phi_cm2 = 4e6 * Math.pow(10, -magnitude / 2.5);
                // 转换为photons/m²-s
                return phi_cm2 * 1e4;
            }
            
            // 计算信号电子数
            calculateSignalElectrons(magnitude, f_frame, N, D, epsilon, eta, tau_a, tau_o, K) {
                // 光子流量密度
                const phi_s = this.calculatePhotonFlux(magnitude);
                
                // 积分时间
                const t_int = 1.0 / f_frame;
                
                // 子孔径直径
                const D_sub = D / Math.sqrt(N);
                
                // 子孔径面积
                const A_sub = Math.PI * Math.pow(D_sub / 2, 2);
                
                // 有效面积（考虑遮拦）
                const A_effective = A_sub * (1 - Math.pow(epsilon, 2));
                
                // 信号电子数
                return (phi_s * eta * t_int * A_effective * tau_a * tau_o) / K;
            }
            
            // 计算信噪比
            calculateSNR(magnitude, f_frame, N, D, epsilon, eta, tau_a, tau_o, sigma_R, I_D, K) {
                // 信号电子数
                const S_M = this.calculateSignalElectrons(magnitude, f_frame, N, D, epsilon, eta, tau_a, tau_o, K);
                
                // 积分时间
                const t_int = 1.0 / f_frame;
                
                // 背景电子数（夜间可忽略）
                const S_B = 0;
                
                // 总噪声方差
                const noise_variance = S_M + S_B + Math.pow(sigma_R, 2) + t_int * I_D;
                
                // 信噪比
                return noise_variance > 0 ? S_M / Math.sqrt(noise_variance) : 0;
            }
            
            // 计算拟合误差平方
            sigmaFittingSquared(r0_ref, wavelength_guide, D, N, k_fitting) {
                const r0_guide = this.calculateR0AtWavelength(r0_ref, wavelength_guide);
                const term = Math.pow(D / r0_guide, 5/3);
                return k_fitting * term * Math.pow(N, -5/6);
            }
            
            // 计算时间误差平方
            sigmaTemporalSquared(f_G, f_frame, f_e3db_ratio) {
                const f_e3db = f_frame / f_e3db_ratio;
                return Math.pow(f_G / f_e3db, 5/3);
            }
            
            // 计算噪声误差平方
            sigmaNoiseSquared(magnitude, f_frame, N, D, epsilon, eta, tau_a, tau_o, sigma_R, I_D, K) {
                const SNR = this.calculateSNR(magnitude, f_frame, N, D, epsilon, eta, tau_a, tau_o, sigma_R, I_D, K);
                return SNR > 0 ? 1.0 / Math.pow(SNR, 2) : 1e6; // 极大值，表示无法测量
            }
            
            // 计算总波前残差平方
            totalWavefrontErrorSquared(params) {
                const {
                    r0_ref, wavelength_guide, D, N, f_G, f_frame, 
                    k_fitting, f_e3db_ratio, magnitude, epsilon, elevation,
                    eta, tau_a, tau_o, sigma_R, I_D, K, sigma_miscel
                } = params;
                
                // 转换为米
                const r0_ref_m = r0_ref / 100; // cm to m
                const wavelength_guide_m = wavelength_guide * 1e-9; // nm to m
                
                // 根据仰角调整r0和tau_a
                const r0_actual = this.calculateR0AtElevation(r0_ref_m, elevation);
                const tau_a_actual = this.calculateTauAAtElevation(tau_a, elevation);
                
                const sigma2_fitting = this.sigmaFittingSquared(r0_actual, wavelength_guide_m, D, N, k_fitting);
                const sigma2_temporal = this.sigmaTemporalSquared(f_G, f_frame, f_e3db_ratio);
                const sigma2_noise = this.sigmaNoiseSquared(
                    magnitude, f_frame, N, D, epsilon, eta, tau_a_actual, tau_o, sigma_R, I_D, K
                );
                
                // 总误差方差
                return {
                    total: sigma2_fitting + sigma2_temporal + sigma2_noise + sigma_miscel,
                    fitting: sigma2_fitting,
                    temporal: sigma2_temporal,
                    noise: sigma2_noise,
                    miscel: sigma_miscel
                };
            }
            
            // 计算斯特列尔比
            calculateStrehlRatio(sigma_total) {
                // SR = exp(-σ^2)，其中σ是波前误差RMS (rad)
                return Math.exp(-Math.pow(sigma_total, 2));
            }
            
            // 根据斯特列尔比计算波前误差
            calculateWavefrontErrorFromSR(SR) {
                // SR = exp(-σ^2) → σ = sqrt(-ln(SR))
                return SR > 0 ? Math.sqrt(-Math.log(SR)) : Infinity;
            }
            
            // 获取参数范围
            getParameterRange(paramName) {
                const ranges = {
                    'r0_ref': { min: 5, max: 20, step: 1 },
                    'N': { min: 100, max: 800, step: 50 },
                    'f_frame': { min: 500, max: 2000, step: 100 },
                    'f_G': { min: 20, max: 200, step: 10 },
                    'magnitude': { min: 5, max: 15, step: 1 },
                    'elevation': { min: 30, max: 90, step: 5 }
                };
                return ranges[paramName] || { min: 0, max: 100, step: 10 };
            }
        }
        
        // 全局变量
        let analyzer = new WavefrontErrorAnalysis();
        let errorChart = null;
        let nmChart = null;
        let srChart = null;
        
        // 获取DOM元素
        const calculateBtn = document.getElementById('calculateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const updateChartBtn = document.getElementById('updateChartBtn');
        const saveParamsBtn = document.getElementById('saveParamsBtn');
        const loadParamsBtn = document.getElementById('loadParamsBtn');
        const fileInput = document.getElementById('fileInput');
        const toggleFormulasBtn = document.getElementById('toggleFormulasBtn');
        const formulasContent = document.getElementById('formulasContent');
        
        const totalErrorEl = document.getElementById('total_error');
        const nmErrorEl = document.getElementById('nm_error');
        const srValueEl = document.getElementById('sr_value');
        const targetEvalEl = document.getElementById('target_eval');
        const intermediateVarsEl = document.getElementById('intermediate_vars');
        
        // 误差分量元素
        const fittingPercentEl = document.getElementById('fitting_percent');
        const temporalPercentEl = document.getElementById('temporal_percent');
        const noisePercentEl = document.getElementById('noise_percent');
        const miscPercentEl = document.getElementById('misc_percent');
        
        const fittingVarianceEl = document.getElementById('fitting_variance');
        const temporalVarianceEl = document.getElementById('temporal_variance');
        const noiseVarianceEl = document.getElementById('noise_variance');
        const miscVarianceEl = document.getElementById('misc_variance');
        
        // 获取输入参数
        function getInputParams() {
            return {
                r0_ref: parseFloat(document.getElementById('r0_ref').value),
                wavelength_guide: parseFloat(document.getElementById('wavelength_guide').value),
                D: parseFloat(document.getElementById('D').value),
                epsilon: parseFloat(document.getElementById('epsilon').value),
                magnitude: parseFloat(document.getElementById('magnitude').value),
                N: parseFloat(document.getElementById('N').value),
                f_frame: parseFloat(document.getElementById('f_frame').value),
                f_G: parseFloat(document.getElementById('f_G').value),
                elevation: parseFloat(document.getElementById('elevation').value),
                k_fitting: parseFloat(document.getElementById('k_fitting').value),
                f_e3db_ratio: parseFloat(document.getElementById('f_e3db_ratio').value),
                sigma_miscel: parseFloat(document.getElementById('sigma_miscel').value),
                eta: parseFloat(document.getElementById('eta').value),
                tau_a: parseFloat(document.getElementById('tau_a').value),
                tau_o: parseFloat(document.getElementById('tau_o').value),
                sigma_R: parseFloat(document.getElementById('sigma_R').value),
                I_D: parseFloat(document.getElementById('I_D').value),
                K: parseFloat(document.getElementById('K').value)
            };
        }
        
        // 设置输入参数
        function setInputParams(params) {
            for (const key in params) {
                const input = document.getElementById(key);
                if (input) {
                    input.value = params[key];
                }
            }
        }
        
        // 保存参数到文件
        function saveParameters() {
            const params = getInputParams();
            const dataStr = JSON.stringify(params, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'wavefront_analysis_params.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 从文件载入参数
        function loadParameters(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const params = JSON.parse(e.target.result);
                    setInputParams(params);
                    calculateAndDisplay();
                } catch (error) {
                    alert('文件格式错误，无法载入参数');
                }
            };
            reader.readAsText(file);
        }
        
        // 重置参数为默认值
        function resetParameters() {
            const defaultParams = {
                r0_ref: 10,
                wavelength_guide: 589,
                D: 2.0,
                epsilon: 0.18,
                magnitude: 8.0,
                N: 400,
                f_frame: 1000,
                f_G: 50,
                elevation: 60,
                k_fitting: 0.3,
                f_e3db_ratio: 25,
                sigma_miscel: 0.05,
                eta: 0.9,
                tau_a: 0.9,
                tau_o: 0.8,
                sigma_R: 0.3,
                I_D: 0.01,
                K: 9
            };
            
            setInputParams(defaultParams);
            calculateAndDisplay();
        }
        
        // 计算并显示结果
        function calculateAndDisplay() {
            const params = getInputParams();
            
            // 计算总误差
            const errorSquared = analyzer.totalWavefrontErrorSquared(params);
            const totalError = Math.sqrt(errorSquared.total);
            
            // 计算等效纳米误差 (@1550nm)
            const nmError = totalError * 1550e-9 * 1e9 / (2 * Math.PI);
            
            // 计算斯特列尔比
            const SR = analyzer.calculateStrehlRatio(totalError);
            
            // 计算天顶距
            const zenithAngle = analyzer.calculateZenithAngle(params.elevation);
            const zenithDistanceDeg = zenithAngle * 180 / Math.PI;
            
            // 计算调整后的r0和tau_a
            const r0_ref_m = params.r0_ref / 100; // cm to m
            const r0_actual = analyzer.calculateR0AtElevation(r0_ref_m, params.elevation);
            const tau_a_actual = analyzer.calculateTauAAtElevation(params.tau_a, params.elevation);
            
            // 计算信噪比
            const wavelength_guide_m = params.wavelength_guide * 1e-9; // nm to m
            const SNR = analyzer.calculateSNR(
                params.magnitude, params.f_frame, params.N, params.D, params.epsilon,
                params.eta, tau_a_actual, params.tau_o, params.sigma_R, params.I_D, params.K
            );
            
            // 计算中间变量
            const photonFlux = analyzer.calculatePhotonFlux(params.magnitude);
            const signalElectrons = analyzer.calculateSignalElectrons(
                params.magnitude, params.f_frame, params.N, params.D, params.epsilon,
                params.eta, tau_a_actual, params.tau_o, params.K
            );
            const r0_guide = analyzer.calculateR0AtWavelength(r0_actual, wavelength_guide_m);
            const D_sub = params.D / Math.sqrt(params.N);
            const A_sub = Math.PI * Math.pow(D_sub / 2, 2);
            const A_effective = A_sub * (1 - Math.pow(params.epsilon, 2));
            const f_e3db = params.f_frame / params.f_e3db_ratio;
            
            // 计算误差分量占比
            const totalVariance = errorSquared.total;
            const fittingPercent = (errorSquared.fitting / totalVariance * 100).toFixed(1);
            const temporalPercent = (errorSquared.temporal / totalVariance * 100).toFixed(1);
            const noisePercent = (errorSquared.noise / totalVariance * 100).toFixed(1);
            const miscPercent = (errorSquared.miscel / totalVariance * 100).toFixed(1);
            
            // 目标评估 (λ/4@1550nm = 387.5nm)
            const targetEval = nmError <= 387.5;
            
            // 显示结果
            totalErrorEl.textContent = totalError.toFixed(4);
            nmErrorEl.textContent = nmError.toFixed(1);
            srValueEl.textContent = (SR * 100).toFixed(1) + '%';
            targetEvalEl.textContent = targetEval ? '达标' : '未达标';
            targetEvalEl.style.color = targetEval ? "#4caf50" : "#f44336";
            
            // 显示误差分量
            fittingPercentEl.textContent = fittingPercent + '%';
            temporalPercentEl.textContent = temporalPercent + '%';
            noisePercentEl.textContent = noisePercent + '%';
            miscPercentEl.textContent = miscPercent + '%';
            
            fittingVarianceEl.textContent = errorSquared.fitting.toFixed(4);
            temporalVarianceEl.textContent = errorSquared.temporal.toFixed(4);
            noiseVarianceEl.textContent = errorSquared.noise.toFixed(4);
            miscVarianceEl.textContent = errorSquared.miscel.toFixed(4);
            
            // 显示中间变量
            intermediateVarsEl.innerHTML = `
                <div class="var-item">
                    <span class="var-name">天顶距 (度):</span>
                    <span class="var-value">${zenithDistanceDeg.toFixed(1)}°</span>
                </div>
                <div class="var-item">
                    <span class="var-name">实际r0 (m):</span>
                    <span class="var-value">${r0_actual.toFixed(4)}</span>
                </div>
                <div class="var-item">
                    <span class="var-name">实际大气透过率:</span>
                    <span class="var-value">${tau_a_actual.toFixed(3)}</span>
                </div>
                <div class="var-item">
                    <span class="var-name">光子流量密度 (photons/m²-s):</span>
                    <span class="var-value">${photonFlux.toExponential(2)}</span>
                </div>
                <div class="var-item">
                    <span class="var-name">信号电子数 (e-):</span>
                    <span class="var-value">${signalElectrons.toFixed(2)}</span>
                </div>
                <div class="var-item">
                    <span class="var-name">信噪比 SNR:</span>
                    <span class="var-value">${SNR.toFixed(2)}</span>
                </div>
                <div class="var-item">
                    <span class="var-name">导星波长r0 (m):</span>
                    <span class="var-value">${r0_guide.toFixed(4)}</span>
                </div>
                <div class="var-item">
                    <span class="var-name">子孔径直径 (m):</span>
                    <span class="var-value">${D_sub.toFixed(3)}</span>
                </div>
                <div class="var-item">
                    <span class="var-name">子孔径面积 (m²):</span>
                    <span class="var-value">${A_sub.toFixed(4)}</span>
                </div>
                <div class="var-item">
                    <span class="var-name">有效面积 (m²):</span>
                    <span class="var-value">${A_effective.toFixed(4)}</span>
                </div>
                <div class="var-item">
                    <span class="var-name">系统带宽 (Hz):</span>
                    <span class="var-value">${f_e3db.toFixed(1)}</span>
                </div>
            `;
            
            // 更新图表
            updateParameterChart();
        }
        
        // 更新参数变化图表
        function updateParameterChart() {
            const paramName = document.getElementById('paramSelect').value;
            const minVal = parseFloat(document.getElementById('paramMin').value);
            const maxVal = parseFloat(document.getElementById('paramMax').value);
            const points = parseInt(document.getElementById('paramPoints').value);
            
            const baseParams = getInputParams();
            
            // 生成参数值序列
            let paramValues = [];
            let step = (maxVal - minVal) / (points - 1);
            
            // 生成更整的数值序列
            for (let i = 0; i < points; i++) {
                let currentVal = minVal + i * step;
                
                // 根据参数类型进行数值优化
                switch(paramName) {
                    case 'r0_ref':
                        currentVal = Math.round(currentVal * 2) / 2; // 步长0.5
                        break;
                    case 'N':
                        currentVal = Math.round(currentVal / 10) * 10; // 10的倍数
                        break;
                    case 'f_frame':
                        currentVal = Math.round(currentVal / 50) * 50; // 50的倍数
                        break;
                    case 'f_G':
                        currentVal = Math.round(currentVal / 5) * 5; // 5的倍数
                        break;
                    case 'magnitude':
                        currentVal = Math.round(currentVal * 2) / 2; // 步长0.5
                        break;
                    case 'elevation':
                        currentVal = Math.round(currentVal); // 整数
                        break;
                }
                
                paramValues.push(currentVal);
            }
            
            // 去重并排序
            paramValues = [...new Set(paramValues)].sort((a, b) => a - b);
            
            const fittingErrors = [];
            const temporalErrors = [];
            const noiseErrors = [];
            const totalErrors = [];
            const nmErrors = [];
            const srValues = [];
            
            for (let i = 0; i < paramValues.length; i++) {
                const currentVal = paramValues[i];
                const testParams = {...baseParams};
                testParams[paramName] = currentVal;
                
                const errorSquared = analyzer.totalWavefrontErrorSquared(testParams);
                const totalError = Math.sqrt(errorSquared.total);
                const nmError = totalError * 1550e-9 * 1e9 / (2 * Math.PI);
                const SR = analyzer.calculateStrehlRatio(totalError);
                
                fittingErrors.push(Math.sqrt(errorSquared.fitting));
                temporalErrors.push(Math.sqrt(errorSquared.temporal));
                noiseErrors.push(Math.sqrt(errorSquared.noise));
                totalErrors.push(totalError);
                nmErrors.push(nmError);
                srValues.push(SR * 100); // 转换为百分比
            }
            
            // 获取参数显示名称
            const paramLabels = {
                'r0_ref': 'r0 (cm)',
                'N': 'DM单元数',
                'f_frame': '帧频 (Hz)',
                'f_G': 'Greenwood频率 (Hz)',
                'magnitude': '导星星等',
                'elevation': '仰角 (度)'
            };
            
            // 更新波前误差图表
            updateErrorChart(paramName, paramValues, paramLabels, fittingErrors, temporalErrors, noiseErrors, totalErrors);
            
            // 更新纳米误差图表
            updateNmChart(paramName, paramValues, paramLabels, nmErrors);
            
            // 更新斯特列尔比图表
            updateSRChart(paramName, paramValues, paramLabels, srValues);
        }
        
        // 更新波前误差图表
        function updateErrorChart(paramName, paramValues, paramLabels, fittingErrors, temporalErrors, noiseErrors, totalErrors) {
            const ctx = document.getElementById('errorChart').getContext('2d');
            
            // 如果图表已存在，先销毁
            if (errorChart) {
                errorChart.destroy();
            }
            
            errorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: paramValues,
                    datasets: [
                        {
                            label: '拟合误差',
                            data: fittingErrors,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: '时间误差',
                            data: temporalErrors,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: '噪声误差',
                            data: noiseErrors,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: '总误差',
                            data: totalErrors,
                            borderColor: 'rgb(201, 203, 207)',
                            backgroundColor: 'rgba(201, 203, 207, 0.1)',
                            tension: 0.4,
                            fill: false,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `波前误差RMS随${paramLabels[paramName]}变化`,
                            color: '#e0e0e0',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: paramLabels[paramName],
                                color: '#e0e0e0'
                            },
                            ticks: {
                                color: '#b0b0b0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: '波前误差RMS (rad)',
                                color: '#e0e0e0'
                            },
                            ticks: {
                                color: '#b0b0b0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // 更新纳米误差图表
        function updateNmChart(paramName, paramValues, paramLabels, nmErrors) {
            const ctx = document.getElementById('nmChart').getContext('2d');
            
            // 如果图表已存在，先销毁
            if (nmChart) {
                nmChart.destroy();
            }
            
            nmChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: paramValues,
                    datasets: [
                        {
                            label: '等效纳米误差',
                            data: nmErrors,
                            borderColor: 'rgb(255, 159, 64)',
                            backgroundColor: 'rgba(255, 159, 64, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `等效纳米误差随${paramLabels[paramName]}变化`,
                            color: '#e0e0e0',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: paramLabels[paramName],
                                color: '#e0e0e0'
                            },
                            ticks: {
                                color: '#b0b0b0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '等效纳米误差 (nm @1550nm)',
                                color: '#e0e0e0'
                            },
                            ticks: {
                                color: '#b0b0b0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // 更新斯特列尔比图表
        function updateSRChart(paramName, paramValues, paramLabels, srValues) {
            const ctx = document.getElementById('srChart').getContext('2d');
            
            // 如果图表已存在，先销毁
            if (srChart) {
                srChart.destroy();
            }
            
            srChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: paramValues,
                    datasets: [
                        {
                            label: '斯特列尔比',
                            data: srValues,
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `斯特列尔比随${paramLabels[paramName]}变化`,
                            color: '#e0e0e0',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: paramLabels[paramName],
                                color: '#e0e0e0'
                            },
                            ticks: {
                                color: '#b0b0b0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '斯特列尔比 (%)',
                                color: '#e0e0e0'
                            },
                            ticks: {
                                color: '#b0b0b0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // 切换公式显示
        function toggleFormulas() {
            formulasContent.classList.toggle('expanded');
            toggleFormulasBtn.textContent = formulasContent.classList.contains('expanded') ? 
                '隐藏计算公式' : '显示计算公式';
        }
        
        // 事件监听
        calculateBtn.addEventListener('click', calculateAndDisplay);
        resetBtn.addEventListener('click', resetParameters);
        updateChartBtn.addEventListener('click', updateParameterChart);
        saveParamsBtn.addEventListener('click', saveParameters);
        loadParamsBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                loadParameters(e.target.files[0]);
            }
        });
        toggleFormulasBtn.addEventListener('click', toggleFormulas);
        
        // 页面加载时自动计算
        window.addEventListener('load', function() {
            // 初始化Mermaid
            mermaid.initialize({
                startOnLoad: true,
                theme: 'dark',
                securityLevel: 'loose'
            });
            
            // 执行计算
            calculateAndDisplay();
        });
    </script>
</body>
</html>
